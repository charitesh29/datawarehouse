
/*
===============================================================================
DDL Script: Create Gold Views
===============================================================================
Script Purpose:
    This script creates views for the Gold layer in the data warehouse. 
    The Gold layer represents the final dimension and fact tables (Star Schema)

    Each view performs transformations and combines data from the Silver layer 
    to produce a clean, enriched, and business-ready dataset.

Usage:
    - These views can be queried directly for analytics and reporting.
===============================================================================
*/

--CREATING DATA MODEL IN GOLD LAYER FOR BUSSINESS CONSUMPTION

--BUILDING CUSTOMER DIM TABLE IN GOLD LAYER

CREATE OR REPLACE VIEW DATA_WAREHOUSE.GOLD.CUSTOMER_DIM
AS
SELECT
ROW_NUMBER() OVER(ORDER BY CST_ID) AS CUST_KEY,--SURROGATE KEY TO JOIN WITH FACT TABLE
CCI.CST_ID AS CUSTOMER_ID,
CCI.CST_KEY AS CUSTOMER_NUMBER,
UPPER(CCI.CST_FIRSTNAME) AS CUST_FIRST_NAME,
UPPER(CCI.CST_LASTNAME) AS CUST_LAST_NAME,
ELA.CNTRY AS CUST_COUNTRY_NAME,
CCI.CST_MARITAL_STATUS AS CUST_MARTIAL_STATUS,
CASE 
    WHEN CCI.CST_GNDR<>'N/A' THEN CCI.CST_GNDR
    ELSE UPPER(COALESCE(ECA.GEN,'N/A'))
END AS GENDER,
ECA.BDATE AS BIRTH_DATE,
CCI.CST_CREATE_DATE AS CREATED_DATE,
FROM DATA_WAREHOUSE.SILVER.CRM_CUST_INFO CCI
LEFT JOIN DATA_WAREHOUSE.SILVER.ERP_CUST_AZ12 ECA
ON CCI.CST_KEY=ECA.CID
LEFT JOIN DATA_WAREHOUSE.SILVER.ERP_LOC_A101 ELA
ON CCI.CST_KEY=ELA.CID
ORDER BY CUSTOMER_ID;

SELECT * FROM DATA_WAREHOUSE.GOLD.CUSTOMER_DIM;

-------------------------------------------------------------------------------------------------------------

--BUILDING PRODUCT DIM TABLE IN GOLD LAYER

CREATE OR REPLACE VIEW DATA_WAREHOUSE.GOLD.PRODUCT_DIM
AS
SELECT
ROW_NUMBER() OVER(ORDER BY PRD_START_DT,PRD_KEY) AS PRODUCT_KEY,
CPI.PRD_ID AS PRODUCT_ID,
CPI.PRD_KEY AS PRODUCT_NUMBER,
CPI.PRD_NM AS PRODUCT_NAME,
CPI.CAT_ID AS CATEGORY_ID,
EPCG.CAT AS CATEGORY,
EPCG.SUBCAT AS SUB_CATEGORY,
EPCG.MAINTENANCE,
CPI.PRD_COST AS COST,
CPI.PRD_LINE AS PRODUCT_LINE,
CPI.PRD_START_DT AS START_DATE,
FROM DATA_WAREHOUSE.SILVER.CRM_PRD_INFO CPI
LEFT JOIN DATA_WAREHOUSE.SILVER.ERP_PX_CAT_G1V2 EPCG
ON CPI.CAT_ID=EPCG.ID
WHERE CPI.PRD_END_DT IS NULL;

SELECT * FROM DATA_WAREHOUSE.GOLD.PRODUCT_DIM;

-------------------------------------------------------------------------------------------------------------

--BUILDING SALES FACT TABLE IN GOLD LAYER

CREATE OR REPLACE VIEW DATA_WAREHOUSE.GOLD.SALES_FACT
AS
SELECT 
CSD.SLS_ORD_NUM AS ORDER_NUMBER,
PD.PRODUCT_KEY,
CD.CUST_KEY,
CSD.SLS_ORDER_DT AS ORDER_DATE,
CSD.SLS_SHIP_DT AS SHIPPING_DATE,
CSD.SLS_DUE_DT AS DUE_DATE,
CSD.SLS_SALES AS SALES_AMOUNT,
CSD.SLS_QUANTITY AS SALES_QUANTITY,
CSD.SLS_PRICE AS SALES_PRICE,
FROM DATA_WAREHOUSE.SILVER.CRM_SALES_DETAILS CSD
LEFT JOIN DATA_WAREHOUSE.GOLD.PRODUCT_DIM PD
ON CSD.SLS_PRD_KEY=PD.PRODUCT_NUMBER
LEFT JOIN DATA_WAREHOUSE.GOLD.CUSTOMER_DIM CD
ON CSD.SLS_CUST_ID=CD.CUSTOMER_ID;

-------------------------------------------------------------------------------------------------------------

SELECT SF.*,CD.*,PD.COST 
FROM DATA_WAREHOUSE.GOLD.SALES_FACT SF
LEFT JOIN DATA_WAREHOUSE.GOLD.CUSTOMER_DIM CD
ON SF.CUST_KEY=CD.CUST_KEY
LEFT JOIN DATA_WAREHOUSE.GOLD.PRODUCT_DIM PD
ON SF.PRODUCT_KEY=PD.PRODUCT_KEY;
